## 🥢 Chopsticks：核心项目概览

**Chopsticks** 是一个面向 Windows（兼顾跨平台）的命令行软件包管理器，旨在**完全兼容 Scoop 的用户体验与目录结构**，同时通过引入 **JavaScript 插件系统**，解决 Scoop 中 JSON manifest 表达能力有限、维护成本高的问题。

其核心哲学是：

> **“保持 Scoop 的简洁与约定，但赋予 manifest 动态能力；让插件强大，而核心保持轻量。”**

---

## 🧩 一、整体架构理念

Chopsticks 采用 **“核心 + 插件”分离架构**：

-   **核心（Core）**：用 Rust 编写，负责 CLI 解析、生命周期管理、安全沙箱、文件系统操作、缓存/持久化/shim 等基础设施。
-   **插件（Scriptlets）**：每个软件由一个独立的 `.js` 文件定义，仅描述“**是什么**”和“**如何安装**”，不依赖核心内部实现。

这种设计确保：
-   用户体验与 Scoop 一致（无缝迁移）
-   插件可独立开发、测试、版本控制
-   核心无需为每个软件定制逻辑，保持稳定

---

## 🗂️ 二、核心模块划分

| 模块                 | 职责              | 说明                                                              |
| -------------------- | ----------------- | ----------------------------------------------------------------- |
| **CLI 引擎**         | 命令解析与分发    | 支持 `install`, `uninstall`, `update`, `bucket`, `cache` 等子命令 |
| **Bucket 管理器**    | 多仓库支持        | 管理 Git-based bucket 列表，拉取/更新插件清单                     |
| **Plugin Loader**    | JS 插件加载与执行 | 安全加载 `.js` 文件，调用标准接口（如 `getManifest`）             |
| **Sandbox Runtime**  | 安全执行环境      | 提供受限的 JS 运行时，防止恶意操作                                |
| **Installer Engine** | 安装流程编排      | 下载 → 校验 → 解压 → 持久化 → 生成 shims                          |
| **Shim Manager**     | 可执行代理生成    | 在 `shims/` 目录创建跨平台可执行入口                              |
| **Persist Handler**  | 用户数据保留      | 在升级时链接 `persist/` 目录，避免配置丢失                        |
| **Cache System**     | 下载内容缓存      | 按 bucket/app/version 结构缓存，支持清理                          |

所有模块均围绕 **Scoop 的五要素** 构建：`apps`, `buckets`, `shims`, `persist`, `cache`。

---

## ⚙️ 三、技术栈选择

### 1. **主语言：Rust**

-   **理由**：内存安全、零成本抽象、优秀的 CLI 工具生态、跨平台支持。
-   **关键优势**：
    -   高性能文件 I/O（适用于大量小文件操作）
    -   强类型系统减少运行时错误
    -   单二进制分发，无运行时依赖

### 2. **JS 引擎：QuickJS（通过 rquickjs）**

-   **理由**：轻量、启动快、无 JIT、易于嵌入、MIT 许可。
-   **优势**：
    -   二进制体积增加 <5MB
    -   毫秒级启动，适合短生命周期 CLI
    -   每个插件独立 Runtime，天然隔离

### 3. **异步运行时：Tokio**

-   **理由**：处理网络请求（下载、版本探测）、并发安装等异步任务。
-   **使用场景**：
    -   并行下载多个软件
    -   异步执行 JS 插件中的 `install()` 逻辑
    -   超时控制与取消

### 4. **依赖管理**

-   **HTTP 客户端**：`reqwest`（支持 HTTPS、重试、代理）
-   **命令行解析**：`clap`（功能强大，支持子命令、自动补全）
-   **路径/目录操作**：`std::fs` + `tempfile` + `dirs`
-   **哈希校验**：`sha2` crate

### 5. **构建与分发**

-   **构建工具**：Cargo（原生支持）
-   **静态链接**：启用 `rquickjs/static-link`，生成单文件可执行程序
-   **分发格式**：Windows `.exe`（优先），macOS/Linux 二进制

---

## 🔒 四、安全模型

-   **插件沙箱**：JS 无法直接访问系统 API，所有 I/O 必须通过 Chopsticks 注入的受控接口。
-   **最小权限原则**：默认禁止网络、文件写入、进程创建；仅在必要时（如 `install` 阶段）开放有限能力。
-   **路径隔离**：所有写入操作限制在 `apps/`, `cache/`, `persist/` 子目录内。
-   **未来扩展**：支持插件签名验证（PGP/Git commit verification）。

---

## 🌐 五、兼容性与扩展性

-   **Scoop 兼容**：
    -   目录结构完全一致
    -   Shim 机制相同
    -   Bucket 概念复用
-   **超越 Scoop**：
    -   动态 manifest（支持自动版本探测）
    -   条件安装逻辑（按 OS/Arch 分支）
    -   自定义安装后处理（如注册服务、配置初始化）
    -   插件可单元测试

---

## ✅ 总结：Chopsticks 的技术定位

| 维度        | 选择                | 目的                   |
| ----------- | ------------------- | ---------------------- |
| **语言**    | Rust                | 安全、高效、可分发     |
| **JS 引擎** | QuickJS             | 轻量、快速、隔离       |
| **架构**    | 核心 + 插件解耦     | 灵活、可维护、社区友好 |
| **安全**    | 沙箱 + 最小权限     | 防止恶意插件破坏系统   |
| **兼容性**  | 100% Scoop 目录结构 | 降低用户迁移成本       |

> **Chopsticks 不是重造轮子，而是用现代技术为 Scoop 的理念注入新活力——让包管理 manifest 从“静态配置”走向“可编程逻辑”，同时坚守简洁、安全、可靠的原则。**